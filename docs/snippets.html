<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 Snippets | The Surgical Informatics Cookbook</title>
  <meta name="description" content="All the brilliant bits of code we don’t want to forget." />
  <meta name="generator" content="bookdown 0.12 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Snippets | The Surgical Informatics Cookbook" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="All the brilliant bits of code we don’t want to forget." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Snippets | The Surgical Informatics Cookbook" />
  
  <meta name="twitter:description" content="All the brilliant bits of code we don’t want to forget." />
  

<meta name="author" content="Surgical Informatics, University of Edinburgh" />


<meta name="date" content="2019-09-27" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="intro.html">
<link rel="next" href="methods.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">The Surgical Informatics Cookbook</a></li>

<li class="divider"></li>
<li><a href="index.html#section"></a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#how-to-contribute"><i class="fa fa-check"></i><b>1.1</b> How to contribute</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#rules-of-posting"><i class="fa fa-check"></i><b>1.2</b> Rules of posting</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#indexing"><i class="fa fa-check"></i><b>1.3</b> Indexing</a><ul>
<li class="chapter" data-level="1.3.1" data-path="intro.html"><a href="intro.html#index"><i class="fa fa-check"></i><b>1.3.1</b> Index</a></li>
<li class="chapter" data-level="1.3.2" data-path="intro.html"><a href="intro.html#chapter-and-section-references"><i class="fa fa-check"></i><b>1.3.2</b> Chapter and section references</a></li>
<li class="chapter" data-level="1.3.3" data-path="intro.html"><a href="intro.html#figure-and-table-references"><i class="fa fa-check"></i><b>1.3.3</b> Figure and table references</a></li>
<li class="chapter" data-level="1.3.4" data-path="intro.html"><a href="intro.html#citations"><i class="fa fa-check"></i><b>1.3.4</b> Citations</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="snippets.html"><a href="snippets.html"><i class="fa fa-check"></i><b>2</b> Snippets</a><ul>
<li class="chapter" data-level="2.1" data-path="snippets.html"><a href="snippets.html#creating-reproducible-r-examples-to-share-in-the-group-binder-holepunch-and-docker"><i class="fa fa-check"></i><b>2.1</b> Creating Reproducible R Examples to Share in the Group (binder, holepunch and docker)</a><ul>
<li class="chapter" data-level="2.1.1" data-path="snippets.html"><a href="snippets.html#create-basic-reproducible-examples"><i class="fa fa-check"></i><b>2.1.1</b> Create Basic Reproducible Examples</a></li>
<li class="chapter" data-level="2.1.2" data-path="snippets.html"><a href="snippets.html#holepunch---complex-reproducible-examples"><i class="fa fa-check"></i><b>2.1.2</b> <code>holepunch</code> - Complex Reproducible Examples</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="snippets.html"><a href="snippets.html#working-with-chis"><i class="fa fa-check"></i><b>2.2</b> Working with CHIs</a><ul>
<li class="chapter" data-level="2.2.1" data-path="snippets.html"><a href="snippets.html#chi_dob---extract-date-of-birth-from-chi"><i class="fa fa-check"></i><b>2.2.1</b> <code>chi_dob()</code> - Extract date of birth from CHI</a></li>
<li class="chapter" data-level="2.2.2" data-path="snippets.html"><a href="snippets.html#chi_gender---extract-gender-from-chi"><i class="fa fa-check"></i><b>2.2.2</b> <code>chi_gender()</code> - Extract gender from CHI</a></li>
<li class="chapter" data-level="2.2.3" data-path="snippets.html"><a href="snippets.html#chi_age---extract-age-from-chi"><i class="fa fa-check"></i><b>2.2.3</b> <code>chi_age()</code> - Extract age from CHI</a></li>
<li class="chapter" data-level="2.2.4" data-path="snippets.html"><a href="snippets.html#chi_valid---logical-test-for-valid-chi"><i class="fa fa-check"></i><b>2.2.4</b> <code>chi_valid()</code> - Logical test for valid CHI</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="snippets.html"><a href="snippets.html#working-with-dates"><i class="fa fa-check"></i><b>2.3</b> Working with dates</a><ul>
<li class="chapter" data-level="2.3.1" data-path="snippets.html"><a href="snippets.html#difference-between-two-dates"><i class="fa fa-check"></i><b>2.3.1</b> Difference between two dates</a></li>
<li class="chapter" data-level="2.3.2" data-path="snippets.html"><a href="snippets.html#lags"><i class="fa fa-check"></i><b>2.3.2</b> Lags</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="methods.html"><a href="methods.html"><i class="fa fa-check"></i><b>3</b> Methods</a></li>
<li class="chapter" data-level="4" data-path="machine-learning.html"><a href="machine-learning.html"><i class="fa fa-check"></i><b>4</b> Machine learning</a><ul>
<li class="chapter" data-level="4.1" data-path="machine-learning.html"><a href="machine-learning.html#deep-learning"><i class="fa fa-check"></i><b>4.1</b> Deep learning</a><ul>
<li class="chapter" data-level="4.1.1" data-path="machine-learning.html"><a href="machine-learning.html#pulling-images-from-redcap-directly-to-argodeep"><i class="fa fa-check"></i><b>4.1.1</b> Pulling images from REDCap directly to argodeep</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="final-words.html"><a href="final-words.html"><i class="fa fa-check"></i><b>5</b> Final Words</a></li>
<li class="chapter" data-level="6" data-path="plotting.html"><a href="plotting.html"><i class="fa fa-check"></i><b>6</b> Plotting</a><ul>
<li class="chapter" data-level="6.1" data-path="plotting.html"><a href="plotting.html#gghighlight-example"><i class="fa fa-check"></i><b>6.1</b> GGHighlight Example</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The Surgical Informatics Cookbook</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="snippets" class="section level1">
<h1><span class="header-section-number">Chapter 2</span> Snippets</h1>
<p>Random useful snippets that do not fit anywhere else.</p>
<div id="creating-reproducible-r-examples-to-share-in-the-group-binder-holepunch-and-docker" class="section level2">
<h2><span class="header-section-number">2.1</span> Creating Reproducible R Examples to Share in the Group (binder, holepunch and docker)</h2>
<p>When asking for help with R code having a reproducible example is crucial (some mock data that others can use along with your code to reproduce your error). Often this can be done easily with creation of a small tibble and posting of the code on slack but sometimes it requires more complex data or the error is due to something in the Linux system in which RStudio server is hosted. For example if the <code>cairo</code> package for Linux isn’t installed then plots don’t work. The <code>holepunch</code> package helps to reproduce examples like these (not suitable for projects with confidential data).</p>
<div id="create-basic-reproducible-examples" class="section level3">
<h3><span class="header-section-number">2.1.1</span> Create Basic Reproducible Examples</h3>
<p>The three main parts of the reproducible example (reprex) in Surgical Informatics are 1. packages, 2. small dataset and 3. code. Other things like R version and Linux version can be assumed as we all use one of only a few servers.</p>
<p>If you have a small (and confidential) set of data in a tibble or data frame called <code>my_data</code> and want it to be easily copied run: <code>dput(droplevels(my_data))</code>. This will print out code in the console that can be copy-pasted to reproduce the data frame. Alternatively use the <code>tibble</code> or <code>tribble</code> functions to create it from scratch (this is preferable for simple datasets). Then copy in the packages and finally the code (ideally the least amount possible to generate the error) and share with the group e.g.:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co"># Output generated from dput(droplevels(my_data))</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">data =<span class="st"> </span><span class="kw">structure</span>(<span class="kw">list</span>(<span class="dt">a =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), <span class="dt">b =</span> <span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>), <span class="dt">c =</span> <span class="dv">10</span><span class="op">:</span><span class="dv">12</span>), <span class="dt">.Names =</span> <span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, </a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>), <span class="dt">row.names =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="op">-</span>3L), <span class="dt">class =</span> <span class="kw">c</span>(<span class="st">&quot;tbl_df&quot;</span>, <span class="st">&quot;tbl&quot;</span>, </a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="st">&quot;data.frame&quot;</span>))</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"></a>
<a class="sourceLine" id="cb3-8" data-line-number="8">data <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">newvar =</span> a <span class="op">/</span>b)</a></code></pre></div>
<pre><code>## Error in a/b: non-numeric argument to binary operator</code></pre>
</div>
<div id="holepunch---complex-reproducible-examples" class="section level3">
<h3><span class="header-section-number">2.1.2</span> <code>holepunch</code> - Complex Reproducible Examples</h3>
<p>From your project with data you are happy to make public make sure you are backed up to <code>git</code> and <code>GitHub</code>. See the relevant chapter on how to do this. Then run the following:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># Holepunch testing</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">remotes<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;karthik/holepunch&quot;</span>)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="kw">library</span>(holepunch)</a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="kw">write_compendium_description</span>(<span class="dt">package =</span> <span class="st">&quot;Title of my project&quot;</span>, </a>
<a class="sourceLine" id="cb5-7" data-line-number="7">                             <span class="dt">description =</span> <span class="st">&quot;Rough description of project or issue&quot;</span>)</a>
<a class="sourceLine" id="cb5-8" data-line-number="8"></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="kw">write_dockerfile</span>(<span class="dt">maintainer =</span> <span class="st">&quot;SurgicalInformatics&quot;</span>)</a>
<a class="sourceLine" id="cb5-10" data-line-number="10"></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="kw">generate_badge</span>()</a>
<a class="sourceLine" id="cb5-12" data-line-number="12"></a>
<a class="sourceLine" id="cb5-13" data-line-number="13"><span class="kw">build_binder</span>()</a></code></pre></div>
<p>The file will generate some text to copy into the top of a <code>README.md</code> file. It will look like:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="op">&lt;!--</span><span class="st"> </span>badges<span class="op">:</span><span class="st"> </span>start <span class="op">-</span>-&gt;</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">[<span class="op">!</span>[Launch Rstudio Binder](http<span class="op">:</span><span class="er">//</span>mybinder.org<span class="op">/</span>badge_logo.svg)](https<span class="op">:</span><span class="er">//</span>mybinder.org<span class="op">/</span>v2<span class="op">/</span>gh<span class="op">/</span>SurgicalInformatics<span class="op">/</span><span class="er">&lt;</span>project<span class="op">&gt;</span><span class="er">/</span>master?<span class="dt">urlpath=</span>rstudio)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="op">&lt;!--</span><span class="st"> </span>badges<span class="op">:</span><span class="st"> </span>end <span class="op">-</span>-&gt;</a></code></pre></div>
<p>Now, whenever somebody clicks on the badge in the <code>README</code> on <code>GitHub</code> they will be taken to an RStudio server instance with all your files (excluding files listed in <code>.gitignore</code>), all the current versions of your package, all the current Linux packages and the current R version. They can then test your code in an near-identical environment to help identify the source of the error, their session will time out after 10 minutes of inactivity or 12 hours since starting and will not save anything so should only be used for bug-testing or quick examples.</p>
<p>As this is a free version of RStudio server there is a limit to what is supported and it shouldn’t be used for computationally-intensive processes.</p>
<p>And, as mentioned: <strong>No confidential data.</strong></p>
</div>
</div>
<div id="working-with-chis" class="section level2">
<h2><span class="header-section-number">2.2</span> Working with CHIs</h2>
<p>Here are 4 functions for CHIs that could even be put in a small package.
The Community Health Index (CHI) is a population register, which is used in Scotland for health care purposes.
The CHI number uniquely identifies a person on the index.</p>
<div id="chi_dob---extract-date-of-birth-from-chi" class="section level3">
<h3><span class="header-section-number">2.2.1</span> <code>chi_dob()</code> - Extract date of birth from CHI</h3>
<p>Note <code>cutoff_2000</code>.
As CHI has only a two digit year, need to decide whether year is 1900s or 2000s.
I don’t think there is a formal way of determining this.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">chi =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;1009701234&quot;</span>, <span class="st">&quot;1811431232&quot;</span>, <span class="st">&quot;1304496368&quot;</span>)</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co"># These CHIs are not real. </span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co"># The first is invalid, two and three are valid. </span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co"># Cut-off any thing before that number is considered 2000s</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co"># i.e. at cutoff_2000 = 20, &quot;18&quot; is considered 2018, rather than 1918. </span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8">chi_dob =<span class="st"> </span><span class="cf">function</span>(.data, <span class="dt">cutoff_2000 =</span> <span class="dv">20</span>){</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">  .data <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="st">    </span>stringr<span class="op">::</span><span class="kw">str_extract</span>(<span class="st">&quot;.{6}&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="st">    </span>lubridate<span class="op">::</span><span class="kw">parse_date_time2</span>(<span class="st">&quot;dmy&quot;</span>, <span class="dt">cutoff_2000 =</span> cutoff_<span class="dv">2000</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="st">    </span>lubridate<span class="op">::</span><span class="kw">as_date</span>() <span class="co"># Make Date object, rather than POSIXct</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb7-14" data-line-number="14"></a>
<a class="sourceLine" id="cb7-15" data-line-number="15"><span class="kw">chi_dob</span>(chi)</a></code></pre></div>
<pre><code>## [1] &quot;1970-09-10&quot; &quot;1943-11-18&quot; &quot;1949-04-13&quot;</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># From tibble</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="kw">tibble</span>(<span class="dt">chi =</span> chi) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">    <span class="dt">dob =</span> <span class="kw">chi_dob</span>(chi)</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">  )</a></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   chi        dob       
##   &lt;chr&gt;      &lt;date&gt;    
## 1 1009701234 1970-09-10
## 2 1811431232 1943-11-18
## 3 1304496368 1949-04-13</code></pre>
</div>
<div id="chi_gender---extract-gender-from-chi" class="section level3">
<h3><span class="header-section-number">2.2.2</span> <code>chi_gender()</code> - Extract gender from CHI</h3>
<p>Ninth digit is odd for men and even for women.
A test for even is <code>x modulus 2 == 0</code>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">chi_gender =<span class="st"> </span><span class="cf">function</span>(.data){</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">  .data <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="st">    </span>stringr<span class="op">::</span><span class="kw">str_sub</span>(<span class="dv">9</span>, <span class="dv">9</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="st">    </span><span class="kw">as.numeric</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="st">    </span>{<span class="kw">ifelse</span>(. <span class="op">%%</span><span class="st"> </span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;Female&quot;</span>, <span class="st">&quot;Male&quot;</span>)}</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb11-7" data-line-number="7"></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="kw">chi_gender</span>(chi)</a></code></pre></div>
<pre><code>## [1] &quot;Male&quot;   &quot;Male&quot;   &quot;Female&quot;</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co"># From tibble</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="kw">tibble</span>(<span class="dt">chi =</span> chi) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">    <span class="dt">dob =</span> <span class="kw">chi_dob</span>(chi),</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">    <span class="dt">gender =</span> <span class="kw">chi_gender</span>(chi)</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">  )</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   chi        dob        gender
##   &lt;chr&gt;      &lt;date&gt;     &lt;chr&gt; 
## 1 1009701234 1970-09-10 Male  
## 2 1811431232 1943-11-18 Male  
## 3 1304496368 1949-04-13 Female</code></pre>
</div>
<div id="chi_age---extract-age-from-chi" class="section level3">
<h3><span class="header-section-number">2.2.3</span> <code>chi_age()</code> - Extract age from CHI</h3>
<p>Works for a single date or a vector of dates.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">chi_age =<span class="st"> </span><span class="cf">function</span>(.data, ref_date, <span class="dt">cutoff_2000 =</span> <span class="dv">20</span>){</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">  dob =<span class="st"> </span><span class="kw">chi_dob</span>(.data, <span class="dt">cutoff_2000 =</span> cutoff_<span class="dv">2000</span>)</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">  lubridate<span class="op">::</span><span class="kw">interval</span>(dob, ref_date) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="st">    </span><span class="kw">as.numeric</span>(<span class="st">&quot;years&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="st">    </span><span class="kw">floor</span>()</a>
<a class="sourceLine" id="cb15-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb15-7" data-line-number="7"></a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="co"># Today</span></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="kw">chi_age</span>(chi, <span class="kw">Sys.time</span>())</a></code></pre></div>
<pre><code>## [1] 49 75 70</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="co"># Single date</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="kw">library</span>(lubridate)</a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="kw">chi_age</span>(chi, <span class="kw">dmy</span>(<span class="st">&quot;11/09/2018&quot;</span>))</a></code></pre></div>
<pre><code>## [1] 48 74 69</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="co"># Vector</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2">dates =<span class="st"> </span><span class="kw">dmy</span>(<span class="st">&quot;11/09/2018&quot;</span>,</a>
<a class="sourceLine" id="cb19-3" data-line-number="3">            <span class="st">&quot;09/05/2015&quot;</span>,</a>
<a class="sourceLine" id="cb19-4" data-line-number="4">            <span class="st">&quot;10/03/2014&quot;</span>)</a>
<a class="sourceLine" id="cb19-5" data-line-number="5"><span class="kw">chi_age</span>(chi, dates)</a></code></pre></div>
<pre><code>## [1] 48 71 64</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="co"># From tibble</span></a>
<a class="sourceLine" id="cb21-2" data-line-number="2"><span class="kw">tibble</span>(<span class="dt">chi =</span> chi) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb21-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb21-4" data-line-number="4">    <span class="dt">dob =</span> <span class="kw">chi_dob</span>(chi),</a>
<a class="sourceLine" id="cb21-5" data-line-number="5">    <span class="dt">gender =</span> <span class="kw">chi_gender</span>(chi),</a>
<a class="sourceLine" id="cb21-6" data-line-number="6">    <span class="dt">age =</span> <span class="kw">chi_age</span>(chi, <span class="kw">Sys.time</span>())</a>
<a class="sourceLine" id="cb21-7" data-line-number="7">  )</a></code></pre></div>
<pre><code>## # A tibble: 3 x 4
##   chi        dob        gender   age
##   &lt;chr&gt;      &lt;date&gt;     &lt;chr&gt;  &lt;dbl&gt;
## 1 1009701234 1970-09-10 Male      49
## 2 1811431232 1943-11-18 Male      75
## 3 1304496368 1949-04-13 Female    70</code></pre>
</div>
<div id="chi_valid---logical-test-for-valid-chi" class="section level3">
<h3><span class="header-section-number">2.2.4</span> <code>chi_valid()</code> - Logical test for valid CHI</h3>
<p>The final digit of the CHI can be used to test that the number is correct via the modulus 11 algorithm.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">chi_valid =<span class="st"> </span><span class="cf">function</span>(.data){</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">  .data <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb23-3" data-line-number="3"><span class="st">    </span>stringr<span class="op">::</span><span class="kw">str_split</span>(<span class="st">&quot;&quot;</span>, <span class="dt">simplify =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb23-4" data-line-number="4"><span class="st">    </span>.[, <span class="dv">-10</span>] <span class="op">%&gt;%</span><span class="st">              </span><span class="co"># Working with matrices hence brackets</span></a>
<a class="sourceLine" id="cb23-5" data-line-number="5"><span class="st">    </span><span class="kw">apply</span>(<span class="dv">1</span>, as.numeric) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># Convert from string</span></a>
<a class="sourceLine" id="cb23-6" data-line-number="6"><span class="st">    </span>{<span class="kw">seq</span>(<span class="dv">10</span>, <span class="dv">2</span>) <span class="op">%*%</span><span class="st"> </span>.} <span class="op">%&gt;%</span><span class="st">    </span><span class="co"># Multiply and sum step</span></a>
<a class="sourceLine" id="cb23-7" data-line-number="7"><span class="st">    </span>{. <span class="op">%%</span><span class="st"> </span><span class="dv">11</span>} <span class="op">%&gt;%</span><span class="st">             </span><span class="co"># Modulus 11</span></a>
<a class="sourceLine" id="cb23-8" data-line-number="8"><span class="st">    </span>{<span class="dv">11</span> <span class="op">-</span><span class="st"> </span>.} <span class="op">%&gt;%</span><span class="st">              </span><span class="co"># Substract from 11</span></a>
<a class="sourceLine" id="cb23-9" data-line-number="9"><span class="st">    </span>dplyr<span class="op">::</span><span class="kw">near</span>(              <span class="co"># Compare result with 10th digit. </span></a>
<a class="sourceLine" id="cb23-10" data-line-number="10">      {stringr<span class="op">::</span><span class="kw">str_sub</span>(chi, <span class="dv">10</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.numeric</span>()}</a>
<a class="sourceLine" id="cb23-11" data-line-number="11">    ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb23-12" data-line-number="12"><span class="st">    </span><span class="kw">as.vector</span>()</a>
<a class="sourceLine" id="cb23-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb23-14" data-line-number="14"></a>
<a class="sourceLine" id="cb23-15" data-line-number="15"><span class="kw">chi_valid</span>(chi)</a></code></pre></div>
<pre><code>## [1] FALSE  TRUE  TRUE</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="co"># From tibble</span></a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="kw">tibble</span>(<span class="dt">chi =</span> chi) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb25-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb25-4" data-line-number="4">    <span class="dt">dob =</span> <span class="kw">chi_dob</span>(chi),</a>
<a class="sourceLine" id="cb25-5" data-line-number="5">    <span class="dt">gender =</span> <span class="kw">chi_gender</span>(chi),</a>
<a class="sourceLine" id="cb25-6" data-line-number="6">    <span class="dt">age =</span> <span class="kw">chi_age</span>(chi, <span class="kw">Sys.time</span>()),</a>
<a class="sourceLine" id="cb25-7" data-line-number="7">    <span class="dt">chi_valid =</span> <span class="kw">chi_valid</span>(chi)</a>
<a class="sourceLine" id="cb25-8" data-line-number="8">  )</a></code></pre></div>
<pre><code>## # A tibble: 3 x 5
##   chi        dob        gender   age chi_valid
##   &lt;chr&gt;      &lt;date&gt;     &lt;chr&gt;  &lt;dbl&gt; &lt;lgl&gt;    
## 1 1009701234 1970-09-10 Male      49 FALSE    
## 2 1811431232 1943-11-18 Male      75 TRUE     
## 3 1304496368 1949-04-13 Female    70 TRUE</code></pre>
</div>
</div>
<div id="working-with-dates" class="section level2">
<h2><span class="header-section-number">2.3</span> Working with dates</h2>
<div id="difference-between-two-dates" class="section level3">
<h3><span class="header-section-number">2.3.1</span> Difference between two dates</h3>
<p>I always forget how to do this neatly.
I often want days as a numeric, not a lubridate type object.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="kw">library</span>(lubridate)</a>
<a class="sourceLine" id="cb27-2" data-line-number="2">date1 =<span class="st"> </span><span class="kw">dmy</span>(<span class="st">&quot;12/03/2018&quot;</span>, <span class="st">&quot;14/05/2017&quot;</span>)</a>
<a class="sourceLine" id="cb27-3" data-line-number="3">date2 =<span class="st"> </span><span class="kw">dmy</span>(<span class="st">&quot;11/09/2019&quot;</span>, <span class="st">&quot;11/04/2019&quot;</span>)</a>
<a class="sourceLine" id="cb27-4" data-line-number="4"></a>
<a class="sourceLine" id="cb27-5" data-line-number="5"><span class="kw">interval</span>(date1, date2) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-6" data-line-number="6"><span class="st">  </span><span class="kw">as.numeric</span>(<span class="st">&quot;days&quot;</span>)</a></code></pre></div>
<pre><code>## [1] 548 697</code></pre>
</div>
<div id="lags" class="section level3">
<h3><span class="header-section-number">2.3.2</span> Lags</h3>
<p>This is useful for calculating, for instance, the period off medications. Lags are much better than long to wide solutions for this.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb29-2" data-line-number="2"><span class="kw">library</span>(lubridate)</a>
<a class="sourceLine" id="cb29-3" data-line-number="3">id =<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>) </a>
<a class="sourceLine" id="cb29-4" data-line-number="4">medication =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;aspirin&quot;</span>, <span class="st">&quot;aspirin&quot;</span>, <span class="st">&quot;aspirin&quot;</span>, <span class="st">&quot;tylenol&quot;</span>, <span class="st">&quot;lipitor&quot;</span>, <span class="st">&quot;advil&quot;</span>) </a>
<a class="sourceLine" id="cb29-5" data-line-number="5">start.date =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;05/01/2017&quot;</span>, <span class="st">&quot;05/30/2017&quot;</span>, <span class="st">&quot;07/15/2017&quot;</span>, <span class="st">&quot;05/01/2017&quot;</span>, <span class="st">&quot;05/06/2017&quot;</span>, <span class="st">&quot;05/28/2017&quot;</span>)</a>
<a class="sourceLine" id="cb29-6" data-line-number="6">stop.date =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;05/04/2017&quot;</span>, <span class="st">&quot;06/10/2017&quot;</span>, <span class="st">&quot;07/27/2017&quot;</span>, <span class="st">&quot;05/15/2017&quot;</span>, <span class="st">&quot;05/12/2017&quot;</span>, <span class="st">&quot;06/13/2017&quot;</span>)</a>
<a class="sourceLine" id="cb29-7" data-line-number="7">df =<span class="st"> </span><span class="kw">tibble</span>(id, medication, start.date, stop.date)</a>
<a class="sourceLine" id="cb29-8" data-line-number="8">df</a></code></pre></div>
<pre><code>## # A tibble: 6 x 4
##      id medication start.date stop.date 
##   &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;     
## 1     2 aspirin    05/01/2017 05/04/2017
## 2     2 aspirin    05/30/2017 06/10/2017
## 3     2 aspirin    07/15/2017 07/27/2017
## 4     2 tylenol    05/01/2017 05/15/2017
## 5     3 lipitor    05/06/2017 05/12/2017
## 6     5 advil      05/28/2017 06/13/2017</code></pre>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1">df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">c</span>(<span class="st">&quot;start.date&quot;</span>, <span class="st">&quot;stop.date&quot;</span>), lubridate<span class="op">::</span>mdy) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># make a date</span></a>
<a class="sourceLine" id="cb31-3" data-line-number="3"><span class="st">  </span><span class="kw">arrange</span>(id, medication, start.date) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-4" data-line-number="4"><span class="st">  </span><span class="kw">group_by</span>(id, medication) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb31-6" data-line-number="6">    <span class="dt">start_date_diff =</span> start.date <span class="op">-</span><span class="st"> </span><span class="kw">lag</span>(start.date),</a>
<a class="sourceLine" id="cb31-7" data-line-number="7">    <span class="dt">medication_period =</span> stop.date<span class="op">-</span>start.date</a>
<a class="sourceLine" id="cb31-8" data-line-number="8">  )</a></code></pre></div>
<pre><code>## # A tibble: 6 x 6
## # Groups:   id, medication [4]
##      id medication start.date stop.date  start_date_diff medication_period
##   &lt;dbl&gt; &lt;chr&gt;      &lt;date&gt;     &lt;date&gt;     &lt;drtn&gt;          &lt;drtn&gt;           
## 1     2 aspirin    2017-05-01 2017-05-04 NA days          3 days          
## 2     2 aspirin    2017-05-30 2017-06-10 29 days         11 days          
## 3     2 aspirin    2017-07-15 2017-07-27 46 days         12 days          
## 4     2 tylenol    2017-05-01 2017-05-15 NA days         14 days          
## 5     3 lipitor    2017-05-06 2017-05-12 NA days          6 days          
## 6     5 advil      2017-05-28 2017-06-13 NA days         16 days</code></pre>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="intro.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="methods.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": ["cookbook.pdf", "cookbook.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
